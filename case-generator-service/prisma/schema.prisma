// This is your Prisma schema file for Detective Sigma Case Generator
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Generation job tracking
model GenerationJob {
  id          String    @id @default(uuid())
  jobId       String    @unique
  request     Json
  status      JobStatus @default(PENDING)
  progress    Int       @default(0)
  attempts    Int       @default(0)
  caseId      String?
  error       String?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([createdAt])
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// Generated case storage
model GeneratedCase {
  id        String   @id @default(uuid())
  caseId    String   @unique
  title     String
  briefing  String   @db.Text
  metadata  Json
  story     Json
  suspects  Json
  clues     Json
  puzzles   Json
  scenes    Json
  assets    Json
  strategy  String
  status    CaseStatus @default(DRAFT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  fingerprint CaseFingerprint?

  @@index([status])
  @@index([createdAt])
}

enum CaseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// Case fingerprint for uniqueness checking
model CaseFingerprint {
  id            String   @id @default(uuid())
  caseId        String   @unique
  structureHash String
  characterHash String
  puzzleHash    String
  locationHash  String
  combinedHash  String   @unique
  createdAt     DateTime @default(now())

  case GeneratedCase @relation(fields: [caseId], references: [caseId], onDelete: Cascade)

  @@index([structureHash])
  @@index([characterHash])
  @@index([puzzleHash])
  @@index([combinedHash])
}
