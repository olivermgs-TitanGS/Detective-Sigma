// Detective Sigma - Prisma Schema
// learn more: https://pris.ly/d/prisma-schema

generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

// ============= USER MANAGEMENT =============

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
}

model User {
  id String @id @default(uuid())
  email String @unique
  username String @unique
  hashedPassword String?
  role UserRole @default(STUDENT)

  // OAuth fields
  image String?
  emailVerified DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLogin DateTime?

  // Relationships
  studentProfile StudentProfile?
  teacherProfile TeacherProfile?
  progress Progress[]
  classesEnrolled ClassMembership[]
  authenticators Authenticator[]

  @@index([email])
  @@index([username])
  @@index([role])
}

// ============= WEBAUTHN / PASSKEYS =============

model Authenticator {
  id String @id @default(uuid())
  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  credentialId String @unique
  credentialPublicKey Bytes
  counter BigInt
  credentialDeviceType String
  credentialBackedUp Boolean
  transports String? // Comma-separated list of transports

  // Device info for user management
  deviceName String?
  lastUsedAt DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([credentialId])
}

model StudentProfile {
  id String @id @default(uuid())
  userId String @unique
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  gradeLevel String // P4, P5, P6
  parentConsent Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TeacherProfile {
  id String @id @default(uuid())
  userId String @unique
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  schoolName String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  classes Class[]
}

// ============= CLASS MANAGEMENT =============

model Class {
  id String @id @default(uuid())
  name String
  classCode String @unique // 6-character join code
  teacherId String
  teacher TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  members ClassMembership[]

  @@index([classCode])
  @@index([teacherId])
}

model ClassMembership {
  id String @id @default(uuid())
  classId String
  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  studentId String
  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)

  joinedAt DateTime @default(now())

  @@unique([classId, studentId])
  @@index([classId])
  @@index([studentId])
}

// ============= CONTENT (CASES) =============

enum SubjectFocus {
  MATH
  SCIENCE
  INTEGRATED
}

enum Difficulty {
  ROOKIE      // P4
  INSPECTOR   // P5
  DETECTIVE   // P6
  CHIEF       // Advanced
}

enum CaseStatus {
  DRAFT
  PUBLISHED
}

model Case {
  id String @id @default(uuid())
  title String
  description String?
  subject String // "Mathematics", "Science", etc.
  subjectFocus SubjectFocus
  difficulty Difficulty
  status CaseStatus @default(DRAFT)

  coverImage String?
  briefingVideoUrl String?
  masterClueFragment String? // Final reveal text
  chapterOrder Int?
  estimatedMinutes Int @default(30)

  // Enhanced fields for FSD compliance
  skillsAssessed Json @default("{}") // {problem_solving: 40, computation: 30, etc.}
  vocabularyWords Json @default("[]") // [{word: "perimeter", meaning: "..."}]
  learningObjectives Json @default("{}") // {primary: "...", secondary: [...]}

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  scenes Scene[]
  suspects Suspect[]
  puzzles Puzzle[]
  progress Progress[]
  assignments CaseAssignment[]
  quizzes Quiz[]

  @@index([status])
  @@index([subjectFocus])
  @@index([difficulty])
}

// ============= SCENES =============

model Scene {
  id String @id @default(uuid())
  caseId String
  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  name String
  description String?
  imageUrl String
  isInitialScene Boolean @default(false)
  orderIndex Int

  createdAt DateTime @default(now())

  // Relationships
  clues Clue[]

  @@index([caseId])
  @@index([orderIndex])
}

// ============= CLUES =============

model Clue {
  id String @id @default(uuid())
  sceneId String
  scene Scene @relation(fields: [sceneId], references: [id], onDelete: Cascade)

  name String
  description String?
  imageUrl String?
  contentRevealed String? // What student learns after collecting
  isHidden Boolean @default(false)

  // Required puzzle to unlock this clue
  requiredPuzzleId String?
  requiredPuzzle Puzzle? @relation(fields: [requiredPuzzleId], references: [id], onDelete: SetNull)

  // Position on scene image (percentage)
  positionX Decimal? // 0-100
  positionY Decimal? // 0-100

  createdAt DateTime @default(now())

  @@index([sceneId])
  @@index([requiredPuzzleId])
}

// ============= SUSPECTS =============

model Suspect {
  id String @id @default(uuid())
  caseId String
  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  name String
  role String? // e.g., "Canteen Manager", "Cleaner"
  imageUrl String?
  bio String?
  isCulprit Boolean @default(false)

  // Dialogue tree stored as JSON
  dialogueTree Json? // {nodes: [{id, question, answer, next: [ids]}]}

  createdAt DateTime @default(now())

  @@index([caseId])
}

// ============= PUZZLES =============

enum PuzzleType {
  MATH_WORD
  SCIENCE_INQUIRY
  LOGIC_CIPHER
  PATTERN_RECOGNITION
}

model Puzzle {
  id String @id @default(uuid())
  caseId String
  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  title String
  type PuzzleType
  questionText String
  questionImage String?
  correctAnswer String
  hint String?

  // For MCQ, stored as JSON array
  options Json? // ["Option A", "Option B", "Option C", "Option D"]

  points Int @default(10)

  // Narrative revelation system - what solving this puzzle reveals about the case
  narrativeContext String?        // Story introduction explaining why this puzzle matters
  investigationPhase String?      // 'initial' | 'investigation' | 'conclusion'
  revelation Json?                // { type, description, storyText, importance }

  // Character connection for story immersion
  relatedCharacterName String?    // Which suspect/character this puzzle relates to

  createdAt DateTime @default(now())

  // Relationships
  clues Clue[] // Clues that require this puzzle

  @@index([caseId])
  @@index([type])
}

// ============= PROGRESS TRACKING =============

enum ProgressStatus {
  NEW
  IN_PROGRESS
  SOLVED
}

model Progress {
  id String @id @default(uuid())
  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  caseId String
  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  status ProgressStatus @default(NEW)
  score Int @default(0)
  currentSceneIndex Int @default(0)
  timeSpent Int @default(0) // seconds

  // Arrays stored as JSON
  cluesCollected Json @default("[]") // Array of clue IDs
  puzzlesSolved Json @default("[]")  // Array of puzzle IDs

  startedAt DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, caseId])
  @@index([userId])
  @@index([caseId])
  @@index([status])
}

// ============= QUIZ SYSTEM =============

model Quiz {
  id String @id @default(uuid())
  caseId String
  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  questions Json // Array of question objects
  orderIndex Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  submissions QuizSubmission[]

  @@index([caseId])
}

model QuizSubmission {
  id String @id @default(uuid())
  quizId String
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
  userId String

  answers Json // Array of user's answers
  correctAnswers Json // Array of correct answers
  score Int // Total score achieved
  maxScore Int // Maximum possible score
  percentageScore Decimal // Calculated percentage

  // Skill-based scores
  skillScores Json @default("{}") // {inference: 80, computation: 90, etc.}

  submittedAt DateTime @default(now())

  @@index([quizId])
  @@index([userId])
}

// ============= ASSIGNMENT SYSTEM =============

model CaseAssignment {
  id String @id @default(uuid())
  caseId String
  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
  teacherId String

  // Can be assigned to entire class or individual student
  classId String?
  studentId String?

  dueDate DateTime?
  assignedAt DateTime @default(now())

  @@index([caseId])
  @@index([teacherId])
  @@index([classId])
  @@index([studentId])
}

// ============= SKILL ASSESSMENT =============

model SkillAssessment {
  id String @id @default(uuid())
  userId String
  subject String // "Mathematics", "Science"
  skillName String // "Problem Solving", "Computation", etc.
  proficiencyLevel Decimal // 0-100 score
  assessedAt DateTime @default(now())

  @@index([userId])
  @@index([subject])
  @@index([skillName])
}

// ============= AUDIT LOG =============

model AuditLog {
  id String @id @default(uuid())
  userId String?
  userEmail String?
  action String // "LOGIN", "CREATE_CASE", "SUBMIT_QUIZ", etc.
  entityType String? // "Case", "Quiz", "Progress"
  entityId String?
  details Json? // Additional context
  ipAddress String?
  userAgent String?

  timestamp DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([timestamp])
}

// ============= VERIFICATION TOKENS =============

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

model VerificationToken {
  id String @id @default(uuid())
  token String @unique
  type TokenType
  email String
  userId String?

  expiresAt DateTime
  usedAt DateTime?

  createdAt DateTime @default(now())

  @@index([token])
  @@index([email])
  @@index([type])
}
